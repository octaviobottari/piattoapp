{% extends 'base.html' %}
{% load static %}
{% block extra_head %}
<title>{{ restaurante.meta_title|default:restaurante.nombre_local }} | Configuraciones</title>
<style>
/* Contenedor general */
.container {
    max-width: 960px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
}

/* T√≠tulos */
h2 {
    font-size: 1.75rem;
    font-weight: 600;
    color: #343a40;
    margin-bottom: 1.5rem;
}
h5.mb-0, h6.mt-4 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #343a40;
}

/* Tarjetas */
.card {
    border: none;
    border-radius: 10px;
    background-color: #ffffff;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    margin-bottom: 1.75rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
}
.card-header {
    background-color: #f85c2b;
    color: #ffffff;
    border-radius: 10px 10px 0 0;
    padding: 1rem 1.25rem;
}
.card-body {
    padding: 1.75rem;
}

/* Formularios */
.form-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: #343a40;
    margin-bottom: 0.3rem;
}
.form-control, .form-control-file {
    border-radius: 6px;
    border: 1px solid #ced4da;
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
.form-control:focus, .form-control-file:focus {
    border-color: #f85c2b;
    box-shadow: 0 0 0 2px rgba(248, 92, 43, 0.2);
    outline: none;
}
textarea.form-control {
    resize: vertical;
    min-height: 80px;
}
.text-muted {
    font-size: 0.85rem;
    color: #6c757d;
}

/* Imagen del logo */
.img-thumbnail {
    border-radius: 8px;
    border: 1px solid #e9ecef;
    max-width: 150px;
    margin-top: 0.5rem;
}

/* Botones */
.btn {
    border-radius: 8px;
    padding: 0.6rem 1.25rem;
    font-size: 0.9rem;
    font-weight: 500;
    transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
}
.btn-success, .btn-primary, .btn-danger {
    background-color: #f85c2b;
    border: none;
    color: #ffffff;
}
.btn-success:hover, .btn-primary:hover, .btn-danger:hover {
    background-color: #d94a1f;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}
.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
}

/* Lista de c√≥digos de descuento */
.list-group {
    border-radius: 8px;
    overflow: hidden;
}
.list-group-item {
    border: 1px solid #e9ecef;
    font-size: 0.9rem;
    color: #343a40;
    background-color: #ffffff;
    padding: 0.75rem 1.25rem;
    transition: background-color 0.2s ease;
}
.list-group-item:hover {
    background-color: #f8f9fa;
}
.list-group-item .btn-danger {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
}

/* Alertas */
.alert {
    border-radius: 8px;
    font-size: 0.9rem;
    padding: 0.75rem 1.25rem;
    margin-top: 0.75rem;
    animation: fadeIn 0.4s ease;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
}
.alert-success {
    background-color: #e6f4ea;
    color: #155724;
    border-color: #c3e6cb;
}
.alert-danger {
    background-color: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
}

/* Estilos para el QR */
.qr-container {
    text-align: center;
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    width: 300px;
    height: 500px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    margin: 0 auto;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
}

.qr-header {
    text-align: center;
    margin-bottom: 15px;
}

.qr-header h2 {
    font-size: 24px;
    font-weight: bold;
    color: #000;
    margin: 0;
}

.qr-header h3 {
    font-size: 18px;
    font-weight: normal;
    color: #000;
    margin: 5px 0 0 0;
}

.divider {
    width: 100%;
    height: 1px;
    background-color: #e0e0e0;
    margin: 10px 0;
}

.qr-image-container {
    background-color: white;
    padding: 15px;
    margin: 15px 0;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
}

.qr-code {
    width: 200px;
    height: 200px;
}

.qr-footer {
    margin-top: 15px;
    text-align: center;
}

.piatto-logo img {
    height: 30px;
    margin-bottom: 10px;
}

.qr-footer-text p {
    margin: 5px 0;
    font-size: 14px;
    color: #666;
}

.qr-footer-text p:first-child {
    font-weight: bold;
}

.btn-download {
    margin-top: 20px;
    background-color: #f85c2b;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}

/* Nuevos estilos para m√©todos de pago deshabilitados */
.payment-disabled {
    opacity: 0.6;
    pointer-events: none;
}

.payment-disabled-message {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 5px;
    padding: 10px;
    margin-top: 10px;
    font-size: 0.9rem;
    color: #6c757d;
}

.mercado-pago-disabled {
    opacity: 0.6;
    pointer-events: none;
}

.mercado-pago-disabled .btn {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    cursor: not-allowed;
}

/* Estilos para la Gu√≠a SEO */
.seo-guide {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    padding: 2rem;
    margin-bottom: 2rem;
    color: white;
}

.seo-guide h3 {
    color: white;
    margin-bottom: 1.5rem;
    text-align: center;
}

.step {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    backdrop-filter: blur(10px);
}

.step-number {
    background: #f85c2b;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 1rem;
    flex-shrink: 0;
}

.step-content h5 {
    color: white;
    margin-bottom: 0.5rem;
}

.step-content p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.example-box {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    padding: 1rem;
    margin-top: 0.5rem;
    border-left: 4px solid #f85c2b;
}

.example-box strong {
    color: #ffd700;
}

.badge-seo {
    background: #f85c2b;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    margin-left: 0.5rem;
}

.character-count {
    font-size: 0.8rem;
    font-weight: 500;
}

.character-count.good {
    color: #28a745;
}

.character-count.warning {
    color: #ffc107;
}

.character-count.danger {
    color: #dc3545;
}


/* Responsividad */
@media (max-width: 768px) {
    .container {
        padding: 1.5rem 1rem;
    }
    .card-body {
        padding: 1.25rem;
    }
    .form-control, .form-control-file {
        font-size: 0.85rem;
    }
    .form-label {
        font-size: 0.85rem;
    }
    .btn {
        width: 100%;
        margin-bottom: 0.75rem;
    }
    .list-group-item {
        font-size: 0.85rem;
        padding: 0.6rem 1rem;
    }
    .img-thumbnail {
        max-width: 120px;
    }
    h2 {
        font-size: 1.5rem;
    }
    .qr-container {
        width: 250px;
        height: 400px;
    }
    .qr-header h2 {
        font-size: 20px;
    }
    .qr-header h3 {
        font-size: 16px;
    }
    .qr-code {
        width: 150px;
        height: 150px;
    }
    .qr-footer-text p {
        font-size: 12px;
    }
    .piatto-logo img {
        height: 25px;
    }
}
@media (max-width: 576px) {
    .col-md-6, .col-md-4, .col-md-2 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    .btn {
        font-size: 0.85rem;
    }
    .card-header {
        padding: 0.75rem 1rem;
    }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2>Configuraciones del Restaurante</h2>

  <!-- Formulario principal -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Configuraci√≥n General</h5>
    </div>
    <div class="card-body">
      <form method="POST" action="{% url 'configurar_restaurante' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Costo de env√≠o y umbral -->
        <div class="mb-3">
          <label class="form-label">Costo de Env√≠o ($)</label>
          {{ config_form.costo_envio }}
          <small class="text-muted">Dejar vac√≠o si no ofrece env√≠o.</small>
        </div>
        <div class="mb-3">
          <label class="form-label">Monto para Env√≠o Gratis ($)</label>
          {{ config_form.umbral_envio_gratis }}
          <small class="text-muted">Dejar vac√≠o si no ofrece env√≠o gratis.</small>
        </div>
        <!-- Meta Tags -->

        <!-- Gu√≠a SEO Completa -->
   <!-- Gu√≠a SEO Completa -->
  <div class="seo-guide">
    <h3>üöÄ Gu√≠a Completa para Aparecer en Google</h3>
    
    <div class="step d-flex">
      <div class="step-number">1</div>
      <div class="step-content">
        <h5>Meta T√≠tulo (M√°x. 60 caracteres)</h5>
        <p>Es lo primero que ven tus clientes en Google. Incluye tu ubicaci√≥n y especialidad.</p>
        <div class="example-box">
          <strong>F√≥rmula ganadora:</strong><br>
          <em>"{{ restaurante.nombre_local }} - [Tu Zona/Localidad] | Piatto"</em><br><br>
          <strong>Ejemplos reales:</strong><br>
          ‚Ä¢ "Pizzer√≠a Napoli - Av. San Mart√≠n 1234 | Piatto"<br>
          ‚Ä¢ "Burger House - Palermo, CABA | Piatto"<br>
          ‚Ä¢ "Sushi Bar - Delivery en Mendoza | Piatto"
        </div>
      </div>
    </div>

    <div class="step d-flex">
      <div class="step-number">2</div>
      <div class="step-content">
        <h5>Meta Descripci√≥n (M√°x. 160 caracteres)</h5>
        <p>Tu carta de presentaci√≥n. Convence a los clientes para que hagan clic.</p>
        <div class="example-box">
          <strong>Estructura que vende:</strong><br>
          <em>"Ped√≠ online de [Tu Restaurante]. [Ubicaci√≥n]. [Especialidades]. [Beneficio √∫nico]."</em><br><br>
          <strong>Ejemplos que convierten:</strong><br>
          ‚Ä¢ "Ped√≠ online de {{ restaurante.nombre_local }}. {{ restaurante.direccion|default:"Tu direcci√≥n" }}. Pizzas, empanadas, delivery. Men√∫ digital con precios actualizados."<br>
          ‚Ä¢ "{{ restaurante.nombre_local }} - Hamburguesas gourmet en Buenos Aires. Delivery r√°pido y take away. Ped√≠ online las 24 horas."
        </div>
      </div>
    </div>

    <div class="step d-flex">
      <div class="step-number">3</div>
      <div class="step-content">
        <h5>Palabras Clave Estrat√©gicas</h5>
        <p>Las palabras que usan tus clientes para buscarte.</p>
        <div class="example-box">
          <strong>Para pizzer√≠as:</strong><br>
          "pizzeria, comida italiana, delivery, {{ restaurante.nombre_local|lower }}, {{ restaurante.ciudad|default:"tu ciudad"|lower }}, empanadas, pizzas, muzzarella, fugazzetta"<br><br>
          <strong>Para hamburgueser√≠as:</strong><br>
          "hamburguesas, burger, delivery, {{ restaurante.nombre_local|lower }}, comida rapida, papas fritas, gourmet, lomito"<br><br>
          <strong>Para sushi:</strong><br>
          "sushi, comida japonesa, delivery, {{ restaurante.nombre_local|lower }}, rolls, sashimi, comida asiatica, pescado fresco"
        </div>
      </div>
    </div>

    <div class="step d-flex">
      <div class="step-number">4</div>
      <div class="step-content">
        <h5>üìç Estrategia por Regiones de Argentina</h5>
        <p>Adapt√° tu SEO seg√∫n tu ubicaci√≥n:</p>
        <div class="example-box">
          <strong>CABA y GBA:</strong> Incluir "CABA", "Capital Federal", "Buenos Aires", barrios como "Palermo", "Recoleta"<br>
          <strong>Provincia de Buenos Aires:</strong> "La Plata", "Mar del Plata", "Quilmes", "Mor√≥n"<br>
          <strong>Interior:</strong> "C√≥rdoba Capital", "Rosario", "Mendoza", "Bariloche" + puntos de referencia
        </div>
      </div>
    </div>
  </div>


        <h6 class="mt-4">Optimizaci√≥n para Buscadores (SEO) <span class="badge-seo">IMPORTANTE</span></h6>
        
        <div class="mb-3">
          <label class="form-label">Meta T√≠tulo <span id="title-counter" class="character-count {% if config_form.meta_title.value|length <= 60 %}good{% else %}danger{% endif %}">({{ config_form.meta_title.value|default:''|length }}/60)</span></label>
          {{ config_form.meta_title }}
          <small class="text-muted">T√≠tulo que aparece en Google. M√°ximo 60 caracteres recomendados.</small>
          <small id="meta-title-warning" class="text-danger" style="display: none;">‚ö†Ô∏è El t√≠tulo excede los 60 caracteres y se ver√° cortado en Google.</small>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Meta Descripci√≥n <span id="description-counter" class="character-count {% if config_form.meta_description.value|length <= 160 %}good{% else %}danger{% endif %}">({{ config_form.meta_description.value|default:''|length }}/160)</span></label>
          {{ config_form.meta_description }}
          <small class="text-muted">Descripci√≥n que aparece bajo el t√≠tulo en Google. M√°ximo 160 caracteres recomendados.</small>
          <small id="meta-description-warning" class="text-danger" style="display: none;">‚ö†Ô∏è La descripci√≥n excede los 160 caracteres y se ver√° cortada en Google.</small>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Meta Palabras Clave</label>
          {{ config_form.meta_keywords }}
          <small class="text-muted">Palabras clave separadas por comas. Ej: "comida, delivery, {{ restaurante.nombre_local|lower }}, {{ restaurante.ciudad|default:"tu ciudad"|lower }}"</small>
        </div>
        <div class="mb-3">
    <label class="form-label">C√≥digo Verificaci√≥n Google - No tocar</label>
    <input type="text" class="form-control" name="google_verification_code" 
           value="{{ restaurante.google_verification_code|default:'' }}"
           placeholder="Ej: ABcDeFgHiJkLmNoPqRsTuVwXyZ012345">
    <small class="text-muted">El c√≥digo de Google Search Console lo hace el Staff de Piatto</small>
</div>
        
        <!-- Vista previa de SEO -->
        <div class="card mt-3">
          <div class="card-header">
            <h5 class="mb-0">üîç Vista Previa de c√≥mo aparec√©s en Google</h5>
          </div>
          <div class="card-body">
            <div class="seo-preview">
              <p class="seo-title" id="seo-title-preview">{{ restaurante.meta_title|default:restaurante.nombre_local }} | Piatto</p>
              <p class="seo-url">https://piattoweb.com{% url 'restaurante_publico' restaurante.username %}</p>
              <p class="seo-description" id="seo-description-preview">{{ restaurante.meta_description|default:'Disfruta de los mejores platos de ' }}{{ restaurante.nombre_local }} con entrega r√°pida.</p>
            </div>
          </div>
        </div>

        <!-- Direcci√≥n -->
        <div class="mb-3">
          <label class="form-label">Direcci√≥n</label>
          {{ config_form.direccion }}
        </div>
        <!-- Tel√©fono -->
        <div class="mb-3">
          <label class="form-label">Tel√©fono</label>
          {{ config_form.telefono }}
          <small class="text-muted">Incluye c√≥digo de pa√≠s (ej. 541123456789 sin el +).</small>
        </div>
        <!-- Logo -->
        <div class="mb-3">
          <label class="form-label">Logo</label>
          {{ config_form.logo }}
          {% if restaurante.logo %}
            <img src="{{ restaurante.logo.url }}" alt="Logo" class="img-thumbnail mt-2" style="max-width: 150px;">
          {% endif %}
        </div>
        <!-- Horarios Escritos -->
        <div class="mb-3">
          <label class="form-label">Horarios Escritos</label>
          {{ config_form.written_schedules }}
          <small class="text-muted">Ej. Lunes a Viernes 12:00-22:00.</small>
        </div>
        <!-- Redes Sociales -->
        <h6 class="mt-4">Redes Sociales</h6>
        <div class="mb-3">
          <label class="form-label">Instagram (Nombre de Usuario)</label>
          {{ config_form.instagram_username }}
          <small class="text-muted">Ej. hvn_burger (sin @).</small>
        </div>
        <div class="mb-3">
          <label class="form-label">Facebook (Nombre de Usuario)</label>
          {{ config_form.facebook_username }}
          <small class="text-muted">Ej. HVNBurger.</small>
        </div>
        <button type="submit" class="btn btn-success">Guardar Configuraci√≥n</button>
      </form>
    </div>
  </div>

  <!-- C√≥digos de Descuento -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">C√≥digos de Descuento</h5>
    </div>
    <div class="card-body">
      <form id="descuentoForm" class="mb-4">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Nombre del C√≥digo</label>
            {{ descuento_form.nombre_codigo }}
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Porcentaje</label>
            {{ descuento_form.porcentaje }}
          </div>
          <div class="col-md-2 mb-3 align-self-end">
            <button type="submit" class="btn btn-primary w-100">A√±adir</button>
          </div>
        </div>
      </form>
      <div id="listaCodigos">
        {% if request.user.codigos_descuento %}
          <ul class="list-group">
            {% for codigo in request.user.codigos_descuento %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ codigo.nombre }} - {{ codigo.porcentaje }}%
                <button class="btn btn-sm btn-danger eliminar-codigo" data-codigo="{{ codigo.nombre }}">Eliminar</button>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No hay c√≥digos de descuento creados.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Secci√≥n M√©todos de Pago -->
  <div class="card">
    <div class="card-header">
        <h5 class="mb-0">Configuraci√≥n de M√©todos de Pago</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{% url 'actualizar_metodos_pago' %}">
            {% csrf_token %}
            
            <!-- Mercado Pago -->
            <div class="mb-3 form-check form-switch {% if restaurante.metodo_pago_alias %}payment-disabled{% endif %}" id="mercado-pago-switch">
                <input class="form-check-input" type="checkbox" name="metodo_pago_mercadopago" 
                       id="metodo_pago_mercadopago" {% if restaurante.metodo_pago_mercadopago %}checked{% endif %}
                       {% if restaurante.metodo_pago_alias %}disabled{% endif %}>
                <label class="form-check-label" for="metodo_pago_mercadopago">
                    Habilitar Mercado Pago
                </label>
                <small class="form-text text-muted d-block">
                    Los clientes podr√°n pagar con tarjetas, efectivo y otros m√©todos a trav√©s de Mercado Pago.
                </small>
                {% if restaurante.metodo_pago_alias %}
                <div class="payment-disabled-message">
                    <i class="fas fa-info-circle"></i> Desactiva el pago por Alias para habilitar Mercado Pago.
                </div>
                {% endif %}
            </div>

            <!-- Pago por Alias -->
            <div class="mb-3 form-check form-switch {% if restaurante.metodo_pago_mercadopago %}payment-disabled{% endif %}" id="alias-switch">
                <input class="form-check-input" type="checkbox" name="metodo_pago_alias" 
                       id="metodo_pago_alias" {% if restaurante.metodo_pago_alias %}checked{% endif %}
                       {% if restaurante.metodo_pago_mercadopago %}disabled{% endif %}
                       onchange="toggleAliasField()">
                <label class="form-check-label" for="metodo_pago_alias">
                    Habilitar Pago por Alias/CBU
                </label>
                <small class="form-text text-muted d-block">
                    Los clientes podr√°n pagar mediante transferencia bancaria.
                </small>
                {% if restaurante.metodo_pago_mercadopago %}
                <div class="payment-disabled-message">
                    <i class="fas fa-info-circle"></i> Desactiva Mercado Pago para habilitar el pago por Alias.
                </div>
                {% endif %}
            </div>

            <!-- Campo Alias/CBU -->
            <div class="mb-3" id="alias-field" style="display: {% if restaurante.metodo_pago_alias %}block{% else %}none{% endif %};">
                <label class="form-label" for="alias_cbu">Alias o CBU para Transferencias</label>
                <input type="text" class="form-control" name="alias_cbu" id="alias_cbu" 
                       value="{{ restaurante.alias_cbu|default:'' }}" 
                       placeholder="Ej: mi.alias.o.cbu" maxlength="100">
                <small class="form-text text-muted">
                    Ingresa tu alias o CBU para que los clientes puedan realizar transferencias.
                </small>
            </div>

            <button type="submit" class="btn btn-success">Guardar Configuraci√≥n de Pagos</button>
        </form>
    </div>
  </div>

  <!-- Integraci√≥n con Mercado Pago -->
  <div class="card {% if not restaurante.metodo_pago_mercadopago %}mercado-pago-disabled{% endif %}" id="mercado-pago-section">
    <div class="card-header">
        <h5 class="mb-0">Integraci√≥n con Mercado Pago</h5>
    </div>
    <div class="card-body">
        {% if not restaurante.metodo_pago_mercadopago %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                La integraci√≥n con Mercado Pago est√° deshabilitada. Activa "Habilitar Mercado Pago" en la secci√≥n de M√©todos de Pago para usar esta funcionalidad.
            </div>
        {% else %}
            {% if restaurante.mp_access_token %}
                <p>Cuenta vinculada: S√≠ (User ID: {{ restaurante.mp_user_id }})</p>
                <h3>Comisiones de Mercado Pago para Checkout Pro (unificadas para tarjeta de cr√©dito, d√©bito, prepaga, efectivo, cuotas sin tarjeta, dinero en cuenta):</h3>
                <p>Los costos var√≠an ligeramente por provincia (excluyen IVA 21% y retenciones como Ingresos Brutos, que pueden agregar hasta 5% dependiendo de la provincia). Ejemplos:</p>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Provincias (mayor√≠a, e.g., Buenos Aires, CABA)</th>
                            <th>Al instante</th>
                            <th>10 d√≠as</th>
                            <th>18 d√≠as</th>
                            <th>35 d√≠as</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Costo base</td>
                            <td>6,29% + IVA</td>
                            <td>4,39% + IVA</td>
                            <td>3,39% + IVA</td>
                            <td>1,49% + IVA</td>
                        </tr>
                    </tbody>
                </table>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Provincias (e.g., C√≥rdoba)</th>
                            <th>Al instante</th>
                            <th>10 d√≠as</th>
                            <th>18 d√≠as</th>
                            <th>35 d√≠as</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Costo base</td>
                            <td>6,53% + IVA</td>
                            <td>4,56% + IVA</td>
                            <td>3,52% + IVA</td>
                            <td>1,55% + IVA</td>
                        </tr>
                    </tbody>
                </table>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Provincias (e.g., Formosa, R√≠o Negro)</th>
                            <th>Al instante</th>
                            <th>10 d√≠as</th>
                            <th>18 d√≠as</th>
                            <th>35 d√≠as</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Costo base</td>
                            <td>6,19% + IVA</td>
                            <td>4,32% + IVA</td>
                            <td>3,34% + IVA</td>
                            <td>1,47% + IVA</td>
                        </tr>
                    </tbody>
                </table>
                <h3>Impuestos aplicables:</h3>
                <ul>
                    <li>IVA: 21% sobre la comisi√≥n base.</li>
                    <li>Retenciones provinciales (e.g., Ingresos Brutos): Var√≠an por provincia (0% a 5%), aplicadas sobre el monto total cobrado.</li>
                    <li>Otras retenciones: Dependiendo de tu situaci√≥n fiscal (e.g., Ganancias, IVA si no est√°s inscripto).</li>
                </ul>
                <p>Nota: Estos valores son para septiembre 2025. Consulta tu cuenta de Mercado Pago para detalles personalizados por tu domicilio y simulaciones exactas. Piatto no cobra comisiones adicionales.</p>
                <form method="post" action="{% url 'desvincular_mercado_pago' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Desvincular Mercado Pago</button>
                </form>
            {% else %}
                <p>Cuenta vinculada: No</p>
                <a href="{% url 'vincular_mercado_pago' %}" class="btn btn-primary">Vincular Mercado Pago</a>
            {% endif %}
        {% endif %}
    </div>
  </div>

  <!-- QR del Local -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">QR del Local</h5>
    </div>
    <div class="card-body">
      <p class="text-muted">Escanea este c√≥digo QR para acceder al men√∫ del restaurante. Descarga un PDF para imprimir.</p>
      <div class="qr-container" id="qrContainer">
        <div class="qr-header">
          <h2>Escane√° y ped√≠</h2>
          <h3>desde tu celular</h3>
        </div>
        <h5 style="color: #f85c2b;">{{ restaurante.nombre_local }}</h5>
        <div class="qr-image-container">
          {% if restaurant_qr.qr_image %}
            <img id="qrImage" src="{{ restaurant_qr.qr_image.url }}" alt="QR Code for {{ restaurant_qr.name }}" class="qr-code" crossorigin="anonymous">
          {% else %}
            <p>Generando QR...</p>
          {% endif %}
        </div>
        <div class="qr-footer">
          <div class="piatto-logo">
            <img src="https://piatto-media-2025.s3.us-east-2.amazonaws.com/media/images/piatto-logo-org.png" alt="Piatto Logo" crossorigin="anonymous">
          </div>
          <div class="qr-footer-text">
            <p style="color: #f85c2b;">Tu negocio, en piloto autom√°tico.</p>
          </div>
        </div>
      </div>
      <button class="btn btn-download" id="downloadPdf">Imprimir PDF</button>
    </div>
  </div>
</div>

<script>
function toggleAliasField() {
    const aliasCheckbox = document.getElementById('metodo_pago_alias');
    const aliasField = document.getElementById('alias-field');
    const aliasCbuInput = document.getElementById('alias_cbu');
    const saveButton = document.querySelector('button[type="submit"]');
    
    if (aliasCheckbox.checked) {
        aliasField.style.display = 'block';
    } else {
        aliasField.style.display = 'none';
    }
}

// Validaci√≥n de exclusividad entre m√©todos de pago - VERSI√ìN CORREGIDA
document.addEventListener('DOMContentLoaded', function() {
    const mercadoPagoSwitch = document.getElementById('metodo_pago_mercadopago');
    const aliasSwitch = document.getElementById('metodo_pago_alias');
    const mercadoPagoSection = document.getElementById('mercado-pago-section');
    const mercadoPagoSwitchContainer = document.getElementById('mercado-pago-switch');
    const aliasSwitchContainer = document.getElementById('alias-switch');
    const aliasField = document.getElementById('alias-field');
    const aliasCbuInput = document.getElementById('alias_cbu');
    const saveButton = document.querySelector('button[type="submit"]');

    function updatePaymentMethodsState() {
        // Limpiar mensajes existentes
        document.querySelectorAll('.payment-disabled-message').forEach(msg => msg.remove());

        // Si Mercado Pago est√° activado, deshabilitar completamente Alias
        if (mercadoPagoSwitch.checked) {
            // Deshabilitar switch de Alias
            aliasSwitch.disabled = true;
            aliasSwitchContainer.classList.add('payment-disabled');
            
            // Ocultar y deshabilitar campo Alias/CBU
            aliasField.style.display = 'none';
            aliasCbuInput.disabled = true;
            
            // Agregar mensaje informativo
            const aliasMessage = document.createElement('div');
            aliasMessage.className = 'payment-disabled-message';
            aliasMessage.innerHTML = '<i class="fas fa-info-circle"></i> Desactiva Mercado Pago para habilitar el pago por Alias.';
            aliasSwitchContainer.appendChild(aliasMessage);
            
            // Habilitar secci√≥n de Mercado Pago
            mercadoPagoSection.classList.remove('mercado-pago-disabled');

        } 
        // Si Alias est√° activado, deshabilitar completamente Mercado Pago
        else if (aliasSwitch.checked) {
            // Deshabilitar switch de Mercado Pago
            mercadoPagoSwitch.disabled = true;
            mercadoPagoSwitchContainer.classList.add('payment-disabled');
            
            // Mostrar campo Alias/CBU
            aliasField.style.display = 'block';
            aliasCbuInput.disabled = false;
            
            // Agregar mensaje informativo
            const mercadoPagoMessage = document.createElement('div');
            mercadoPagoMessage.className = 'payment-disabled-message';
            mercadoPagoMessage.innerHTML = '<i class="fas fa-info-circle"></i> Desactiva el pago por Alias para habilitar Mercado Pago.';
            mercadoPagoSwitchContainer.appendChild(mercadoPagoMessage);
            
            // Deshabilitar secci√≥n de Mercado Pago
            mercadoPagoSection.classList.add('mercado-pago-disabled');

        } 
        // Si ambos est√°n desactivados
        else {
            // Habilitar ambos switches
            mercadoPagoSwitch.disabled = false;
            aliasSwitch.disabled = false;
            mercadoPagoSwitchContainer.classList.remove('payment-disabled');
            aliasSwitchContainer.classList.remove('payment-disabled');
            
            // Ocultar campo Alias/CBU
            aliasField.style.display = 'none';
            aliasCbuInput.disabled = true;
            
            // Deshabilitar secci√≥n de Mercado Pago si no est√° activado
            if (!mercadoPagoSwitch.checked) {
                mercadoPagoSection.classList.add('mercado-pago-disabled');
            }
        }
    }

    // Funci√≥n para manejar el cambio en Mercado Pago
    function handleMercadoPagoChange() {
        if (this.checked) {
            // Si se activa Mercado Pago, desactivar Alias autom√°ticamente
            aliasSwitch.checked = false;
            toggleAliasField();
        }
        updatePaymentMethodsState();
    }

    // Funci√≥n para manejar el cambio en Alias
    function handleAliasChange() {
        if (this.checked) {
            // Si se activa Alias, desactivar Mercado Pago autom√°ticamente
            mercadoPagoSwitch.checked = false;
        }
        toggleAliasField();
        updatePaymentMethodsState();
    }

    // Inicializar estado
    updatePaymentMethodsState();
    toggleAliasField();

    // Escuchar cambios en los switches
    mercadoPagoSwitch.addEventListener('change', handleMercadoPagoChange);
    aliasSwitch.addEventListener('change', handleAliasChange);

    // Tambi√©n actualizar el estado cuando se carga la p√°gina para mensajes iniciales
    setTimeout(updatePaymentMethodsState, 100);
});

// Discount codes handling
document.getElementById('descuentoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{% url 'agregar_codigo_descuento' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const listaCodigos = document.getElementById('listaCodigos');
            const noCodigosMsg = listaCodigos.querySelector('.text-muted');
            if (noCodigosMsg) noCodigosMsg.remove();
            const ul = listaCodigos.querySelector('ul') || document.createElement('ul');
            ul.classList.add('list-group');
            const li = document.createElement('li');
            li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
            li.innerHTML = `${data.codigo.nombre} - ${data.codigo.porcentaje}% <button class="btn btn-sm btn-danger eliminar-codigo" data-codigo="${data.codigo.nombre}">Eliminar</button>`;
            ul.appendChild(li);
            if (!listaCodigos.querySelector('ul')) listaCodigos.appendChild(ul);
            document.getElementById('descuentoForm').reset();
        } else {
            alert('Error: ' + (data.error || 'No se pudo a√±adir el c√≥digo.'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ocurri√≥ un error al a√±adir el c√≥digo.');
    });
});

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('eliminar-codigo')) {
        const nombreCodigo = e.target.dataset.codigo;
        if (confirm(`¬øEliminar el c√≥digo ${nombreCodigo}?`)) {
            fetch("{% url 'eliminar_codigo_descuento' %}", {
                method: 'POST',
                body: new URLSearchParams({ 'nombre_codigo': nombreCodigo }),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    e.target.parentElement.remove();
                    const listaCodigos = document.getElementById('listaCodigos');
                    if (!listaCodigos.querySelector('li')) {
                        listaCodigos.innerHTML = '<p class="text-muted">No hay c√≥digos de descuento creados.</p>';
                    }
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar el c√≥digo.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocurri√≥ un error al eliminar el c√≥digo.');
            });
        }
    }
});

// PDF Download Handler
document.getElementById('downloadPdf').addEventListener('click', function() {
    const qrCard = document.querySelector('.card:last-child');
    const qrImage = document.getElementById('qrImage');
    const restaurantName = "{{ restaurante.nombre_local|default:'default' }}".replace(/ /g, '-').toLowerCase();
    const restaurantSlug = "{{ restaurante.nombre_local|default:'nombrerestaurante'|lower|slugify }}";

    if (!qrImage || !qrImage.src) {
        alert('No se encontr√≥ la imagen QR. Aseg√∫rate de que el QR est√© generado.');
        return;
    }

    const loadImageAsDataURL = (src) => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => {
                console.log(`Imagen cargada exitosamente: ${src}`);
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL('image/png'));
            };
            img.onerror = (err) => {
                console.error(`Error al cargar imagen: ${src}`, err);
                reject(new Error(`No se pudo cargar la imagen: ${src}`));
            };
            img.src = src;
        });
    };

    const qrImageUrl = new URL(qrImage.src, window.location.origin).href;
    const logoImageUrl = new URL('https://piatto-media-2025.s3.us-east-2.amazonaws.com/media/images/piatto-logo-org.png', window.location.origin).href;

    console.log('Intentando cargar im√°genes para PDF:', { qrImageUrl, logoImageUrl });

    Promise.all([
        loadImageAsDataURL(qrImageUrl).catch(err => {
            console.error('Error al cargar imagen QR:', err);
            alert('No se pudo cargar la imagen QR. Intentando generar PDF sin QR.');
            return null;
        }),
        loadImageAsDataURL(logoImageUrl).catch(err => {
            console.error('Error al cargar logo de Piatto:', err);
            return null;
        })
    ]).then(([qrDataUrl, logoDataUrl]) => {
        if (!qrDataUrl) {
            alert('No se pudo cargar la imagen QR. No se puede generar el PDF.');
            return;
        }

        const element = document.createElement('div');
        element.style.textAlign = 'center';
        element.style.backgroundColor = 'white';
        element.style.padding = '20px';
        element.style.borderRadius = '10px';
        element.style.width = '400px';
        element.style.height = '650px';
        element.style.display = 'flex';
        element.style.flexDirection = 'column';
        element.style.justifyContent = 'space-between';
        element.style.alignItems = 'center';
        element.style.margin = '0 auto';
        element.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.08)';
        element.style.fontFamily = 'Arial, sans-serif';

        element.innerHTML = `
            <div style="padding: 1.75rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; align-items: center;">
                <div style="text-align: center; background-color: white; border-radius: 10px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; align-items: center;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h2 style="font-size: 24px; font-weight: bold; color: #000; margin: 0;">Escane√° y ped√≠</h2>
                        <h3 style="font-size: 18px; font-weight: normal; color: #000; margin: 5px 0 0 0;">desde tu celular</h3>
                    </div>
                    <h5 style="color: #f85c2b; margin: 10px 0;">{{ restaurante.nombre_local }}</h5>
                    <div style="background-color: white; padding: 15px; margin: 15px 0; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <img src="${qrDataUrl}" style="width: 250px; height: 250px;" />
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <div style="margin-bottom: 10px;">
                            ${logoDataUrl ? `<img src="${logoDataUrl}" style="height: 40px;" />` : '<p style="color: #666;">Logo no disponible</p>'}
                        </div>
                        <div>
                            <p style="margin: 5px 0; font-size: 14px; color: #666; font-weight: bold;">Tu negocio, en piloto autom√°tico.</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(element);

        html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: true,
            allowTaint: false,
            backgroundColor: null,
            onclone: (document, element) => {
                console.log('Clonando elemento para html2canvas');
                return true;
            }
        }).then(canvas => {
            document.body.removeChild(element);
            const imgData = canvas.toDataURL('image/png');
            console.log('Canvas generado, generando PDF...');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const imgWidth = 400;
            const imgHeight = 650;
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const ratio = Math.min(pdfWidth / (imgWidth * 0.264583), pdfHeight / (imgHeight * 0.264583));
            const scaledWidth = imgWidth * ratio * 0.264583;
            const scaledHeight = imgHeight * ratio * 0.264583;
            const x = (pdfWidth - scaledWidth) / 2;
            const y = (pdfHeight - scaledHeight) / 2;

            pdf.addImage(imgData, 'PNG', x, y, scaledWidth, scaledHeight);
            pdf.save(`qr-menu-${restaurantName}.pdf`);
            console.log('PDF generado exitosamente:', `qr-menu-${restaurantName}.pdf`);
        }).catch(err => {
            document.body.removeChild(element);
            console.error('Error al generar el PDF:', err);
            alert('Error al generar el PDF. Detalles en la consola.');
        });
    }).catch(err => {
        console.error('Error al cargar im√°genes para PDF:', err);
        alert(`No se pudieron cargar las im√°genes para el PDF: ${err.message}`);
    });
});

// Validaci√≥n de longitud y actualizaci√≥n de vista previa
document.addEventListener('DOMContentLoaded', function() {
    const metaTitleInput = document.querySelector('input[name="meta_title"]');
    const metaDescriptionInput = document.querySelector('textarea[name="meta_description"]');
    const metaTitleWarning = document.getElementById('meta-title-warning');
    const metaDescriptionWarning = document.getElementById('meta-description-warning');
    const seoTitlePreview = document.getElementById('seo-title-preview');
    const seoDescriptionPreview = document.getElementById('seo-description-preview');

    function updateMetaTitle() {
        const title = metaTitleInput.value || '{{ restaurante.nombre_local|escapejs }}';
        seoTitlePreview.textContent = title + ' | Piatto';
        metaTitleWarning.style.display = metaTitleInput.value.length > 60 ? 'block' : 'none';
    }

    function updateMetaDescription() {
        const description = metaDescriptionInput.value || 'Disfruta de los mejores platos de {{ restaurante.nombre_local|escapejs }} con entrega r√°pida.';
        seoDescriptionPreview.textContent = description;
        metaDescriptionWarning.style.display = metaDescriptionInput.value.length > 160 ? 'block' : 'none';
    }

    metaTitleInput.addEventListener('input', updateMetaTitle);
    metaDescriptionInput.addEventListener('input', updateMetaDescription);

    // Inicializar vista previa
    updateMetaTitle();
    updateMetaDescription();
});
</script>
{% endblock %}